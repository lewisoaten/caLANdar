name: Cloud Run Deployment

on:
  push:
    branches: [main, staging]
    paths:
      - "api/**"
      - ".github/workflows/cloudrun-deploy.yml"
      - "Justfile"
      - ".env.example"
  pull_request:
    paths:
      - "api/**"
      - ".github/workflows/cloudrun-deploy.yml"
      - "Justfile"
      - ".env.example"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: cloudrun-${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'production' || 'staging' }}-deployment
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  IMAGE_NAME: calandar-api
  DEPLOY_TAG: candidate
  # Determine target environment based on trigger
  # Production: push to main branch only
  # Staging: PRs, push to staging, or push to main (for testing)
  TARGET_ENV: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') && 'production' || (github.event_name == 'workflow_dispatch' && inputs.environment) || 'staging' }}

jobs:
  build-and-test:
    name: Build and Test Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up cargo cache
        uses: actions/cache@v4
        continue-on-error: false
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            api/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Build backend
        run: cargo build --verbose --release --no-default-features
        working-directory: ./api

      - name: Run backend tests
        run: cargo test --verbose --no-default-features
        working-directory: ./api

  build-and-push-image:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      id-token: write
    outputs:
      image-url: ${{ steps.build-push.outputs.image-url }}
      image-digest: ${{ steps.build-push.outputs.image-digest }}
      target-env: ${{ steps.set-env.outputs.target-env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set target environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "target-env=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "target-env=production" >> $GITHUB_OUTPUT
          else
            echo "target-env=staging" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Build and push Docker image
        id: build-push
        env:
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
          GCP_REGION: ${{ env.GCP_REGION }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: just cloudrun-build-push ${{ github.sha }}

  upsert-secrets:
    name: Upsert Secrets to GCP Secret Manager
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set target environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "target-env=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "target-env=production" >> $GITHUB_OUTPUT
          else
            echo "target-env=staging" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Upsert secrets to Secret Manager
        env:
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
          DATABASE_URL: ${{ steps.set-env.outputs.target-env == 'production' && secrets.DATABASE_URL_PRODUCTION || secrets.DATABASE_URL }}
          PASETO_SECRET_KEY: ${{ secrets.PASETO_SECRET_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
        run: just cloudrun-upsert-secrets

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [build-and-push-image, upsert-secrets]
    permissions:
      contents: read
      id-token: write
    outputs:
      service-url: ${{ steps.deploy.outputs.service-url }}
      revision: ${{ steps.deploy.outputs.revision }}
      previous-revision: ${{ steps.deploy.outputs.previous-revision }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set deployment configuration
        id: config
        run: |
          TARGET_ENV="${{ needs.build-and-push-image.outputs.target-env }}"
          if [ "$TARGET_ENV" = "production" ]; then
            echo "service-name=calandar-api-production" >> $GITHUB_OUTPUT
          else
            echo "service-name=calandar-api-staging" >> $GITHUB_OUTPUT
          fi
          echo "target-env=$TARGET_ENV" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Deploy to Cloud Run
        id: deploy
        env:
          GCP_REGION: ${{ env.GCP_REGION }}
          SERVICE_NAME: ${{ steps.config.outputs.service-name }}
          DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
        run: just cloudrun-deploy ${{ needs.build-and-push-image.outputs.image-url }}

  health-check:
    name: Health Check and Traffic Migration
    runs-on: ubuntu-latest
    needs: deploy
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set deployment configuration
        id: config
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ github.event_name }}" = "push" ]; then
            echo "service-name=calandar-api-production" >> $GITHUB_OUTPUT
          else
            echo "service-name=calandar-api-staging" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Run health check on new revision
        env:
          GCP_REGION: ${{ env.GCP_REGION }}
          SERVICE_NAME: ${{ steps.config.outputs.service-name }}
          DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
        run: just cloudrun-health-check ${{ needs.deploy.outputs.revision }}

      - name: Migrate traffic to new revision
        if: success()
        env:
          GCP_REGION: ${{ env.GCP_REGION }}
          SERVICE_NAME: ${{ steps.config.outputs.service-name }}
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
        run: just cloudrun-migrate-traffic ${{ needs.deploy.outputs.revision }}

      - name: Verify service health
        if: success()
        env:
          GCP_REGION: ${{ env.GCP_REGION }}
          SERVICE_NAME: ${{ steps.config.outputs.service-name }}
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
        run: just cloudrun-verify-service

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: failure() && needs.health-check.result == 'failure' && needs.deploy.outputs.previous-revision != 'none'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set deployment configuration
        id: config
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ github.event_name }}" = "push" ]; then
            echo "service-name=calandar-api-production" >> $GITHUB_OUTPUT
          else
            echo "service-name=calandar-api-staging" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Rollback to previous revision
        env:
          GCP_REGION: ${{ env.GCP_REGION }}
          SERVICE_NAME: ${{ steps.config.outputs.service-name }}
          GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
        run: just cloudrun-rollback ${{ needs.deploy.outputs.previous-revision }}
