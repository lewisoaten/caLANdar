name: Cloud Run Staging Deployment

on:
  push:
    branches: [main, staging]
    paths:
      - "api/**"
      - ".github/workflows/cloudrun-staging.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "api/**"
      - ".github/workflows/cloudrun-staging.yml"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  GCP_REGION: us-central1
  SERVICE_NAME: calandar-api-staging
  IMAGE_NAME: calandar-api

jobs:
  build-and-test:
    name: Build and Test Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up cargo cache
        uses: actions/cache@v4
        continue-on-error: false
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            api/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Build backend
        run: cargo build --verbose --release --no-default-features
        working-directory: ./api

      - name: Run backend tests
        run: cargo test --verbose --no-default-features
        working-directory: ./api

  build-and-push-image:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging')
    permissions:
      contents: read
      id-token: write
    outputs:
      image-url: ${{ steps.build-image.outputs.image-url }}
      image-digest: ${{ steps.build-image.outputs.image-digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and push Docker image
        id: build-image
        run: |
          # Generate image tag
          IMAGE_TAG="${{ github.sha }}"
          IMAGE_URL="${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/calandar/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          LATEST_URL="${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/calandar/${{ env.IMAGE_NAME }}:latest"

          # Build the Docker image
          docker build \
            -f api/Dockerfile.cloudrun \
            -t "${IMAGE_URL}" \
            -t "${LATEST_URL}" \
            api/

          # Push both tags
          docker push "${IMAGE_URL}"
          docker push "${LATEST_URL}"

          # Output for next job
          echo "image-url=${IMAGE_URL}" >> $GITHUB_OUTPUT

          # Get image digest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${IMAGE_URL}" | cut -d'@' -f2)
          echo "image-digest=${DIGEST}" >> $GITHUB_OUTPUT

  deploy-to-staging:
    name: Deploy to Cloud Run Staging
    runs-on: ubuntu-latest
    needs: build-and-push-image
    permissions:
      contents: read
      id-token: write
    outputs:
      service-url: ${{ steps.deploy.outputs.service-url }}
      revision: ${{ steps.deploy.outputs.revision }}
      previous-revision: ${{ steps.get-current.outputs.revision }}
    steps:
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get current revision (for potential rollback)
        id: get-current
        run: |
          CURRENT_REVISION=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.latestReadyRevisionName)' 2>/dev/null || echo "none")
          echo "revision=${CURRENT_REVISION}" >> $GITHUB_OUTPUT
          echo "Current revision: ${CURRENT_REVISION}"

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ needs.build-and-push-image.outputs.image-url }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --set-env-vars "RUST_LOG=info,PORT=8080" \
            --set-secrets "DATABASE_URL=DATABASE_URL:latest,PASETO_SECRET_KEY=PASETO_SECRET_KEY:latest,RESEND_API_KEY=RESEND_API_KEY:latest,STEAM_API_KEY=STEAM_API_KEY:latest" \
            --min-instances 0 \
            --max-instances 10 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 60s \
            --no-traffic

          # Get the new revision name
          NEW_REVISION=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.latestCreatedRevisionName)')
          echo "revision=${NEW_REVISION}" >> $GITHUB_OUTPUT

          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "service-url=${SERVICE_URL}" >> $GITHUB_OUTPUT

          echo "Deployed revision: ${NEW_REVISION}"
          echo "Service URL: ${SERVICE_URL}"

  health-check:
    name: Health Check and Traffic Migration
    runs-on: ubuntu-latest
    needs: deploy-to-staging
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run smoke tests on new revision
        id: smoke-test
        run: |
          # Wait for the revision to be ready
          echo "Waiting for revision to be ready..."
          sleep 10

          # Get revision URL for testing (before traffic migration)
          REVISION_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.traffic[0].url)')

          # If no specific revision URL, use the main service URL with revision tag
          if [ -z "${REVISION_URL}" ]; then
            REVISION_URL="${{ needs.deploy-to-staging.outputs.service-url }}"
          fi

          echo "Testing revision at: ${REVISION_URL}"

          # Health check with retries
          MAX_RETRIES=10
          RETRY_COUNT=0
          HEALTH_CHECK_PASSED=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${REVISION_URL}/api/healthz" || echo "000")
            echo "Attempt $((RETRY_COUNT + 1)): Health check returned HTTP ${HTTP_CODE}"

            if [ "${HTTP_CODE}" = "204" ]; then
              echo "Health check passed!"
              HEALTH_CHECK_PASSED=true
              break
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Retrying in 5 seconds..."
              sleep 5
            fi
          done

          if [ "${HEALTH_CHECK_PASSED}" = "false" ]; then
            echo "Health check failed after ${MAX_RETRIES} attempts"
            exit 1
          fi

      - name: Migrate traffic to new revision
        if: success()
        run: |
          echo "Migrating 100% traffic to new revision: ${{ needs.deploy-to-staging.outputs.revision }}"
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --to-revisions ${{ needs.deploy-to-staging.outputs.revision }}=100

      - name: Final verification
        if: success()
        run: |
          echo "Running final verification..."
          sleep 5

          SERVICE_URL="${{ needs.deploy-to-staging.outputs.service-url }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/api/healthz")

          if [ "${HTTP_CODE}" = "204" ]; then
            echo "✅ Deployment successful! Service is healthy at ${SERVICE_URL}"
          else
            echo "❌ Final verification failed with HTTP ${HTTP_CODE}"
            exit 1
          fi

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-to-staging, health-check]
    if: failure() && needs.deploy-to-staging.outputs.previous-revision != 'none'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Rollback to previous revision
        run: |
          echo "⚠️ Rolling back to previous revision: ${{ needs.deploy-to-staging.outputs.previous-revision }}"

          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --to-revisions ${{ needs.deploy-to-staging.outputs.previous-revision }}=100

          echo "✅ Rollback complete"

      - name: Verify rollback
        run: |
          sleep 5
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/api/healthz")

          if [ "${HTTP_CODE}" = "204" ]; then
            echo "✅ Rollback successful! Service is healthy"
          else
            echo "⚠️ Warning: Service may still be unhealthy after rollback (HTTP ${HTTP_CODE})"
          fi
